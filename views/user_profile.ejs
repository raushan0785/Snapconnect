<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/user_profile.css">
    <img src="<%= user.avatar %>" alt="<%= user.name %>" width="100">
</head>
<body>
    <h1>Codeial / Profile Page</h1>

    <% if (profile_user) { %> <!-- Check if profile_user is defined -->
        <h2><%= profile_user.name %>'s Profile</h2>
        <p>Email: <%= profile_user.email %></p>
        <ul>
            <!-- Link to the current user's profile with their ID -->
            <li>
                <a href="/users/profile/<%= profile_user.id %>"><%= profile_user.name %></a>
            </li>
            <% if (user && user.id !== profile_user.id) { %>
                <% if (profile_user.friends && profile_user.friends.includes(user.id)) { %>
                    <form action="/users/remove-friend/<%= profile_user.id %>" method="POST">
                        <button type="submit">Remove Friend</button>
                    </form>
                <% } else if (profile_user.friendRequests && profile_user.friendRequests.includes(user.id)) { %>
                    <span>Request Sent</span>
                <% } else if (user.friendRequests && user.friendRequests.includes(profile_user.id)) { %>
                    <form action="/users/accept-request/<%= profile_user.id %>" method="POST">
                        <button type="submit">Accept</button>
                    </form>
                    <form action="/users/reject-request/<%= profile_user.id %>" method="POST">
                        <button type="submit">Reject</button>
                    </form>
                <% } else { %>
                    <form action="/users/send-request/<%= profile_user.id %>" method="POST">
                        <button type="submit">Send Friend Request</button>
                    </form>
                <% } %>
            <% } %>
            <% if (user && user.id === profile_user.id) { %>
                <!-- Show the form if the logged-in user matches the profile_user -->
                <form action="/users/update/<%= profile_user.id %>" enctype="multipart/form-data" method="POST">
                    <input type="text" name="name" placeholder="Your Name" value="<%= profile_user.name %>" required>
                    <input type="email" name="email" placeholder="Your Email" value="<%= profile_user.email %>" required>
                    <input type="file" name="avatar" placeholder="profile picture">
                    <input type="submit" value="Update">
                </form>
            <% } %> <!-- End of form display logic -->
            <li>
                <a href="/users/sign-out">Sign Out</a>
            </li>
        </ul>
        <% if (user && user.id === profile_user.id) { %>
            <h3>Friends</h3>
            <ul>
                <% if (user.friends && user.friends.length > 0) { %>
                    <% user.friends.forEach(function(friendId) { %>
                        <li><a href="/users/profile/<%= friendId %>">Friend: <%= friendId %></a></li>
                    <% }); %>
                <% } else { %>
                    <li>No friends yet.</li>
                <% } %>
            </ul>
            <h3>Pending Friend Requests</h3>
            <ul>
                <% if (user.friendRequests && user.friendRequests.length > 0) { %>
                    <% user.friendRequests.forEach(function(requestId) { %>
                        <li><a href="/users/profile/<%= requestId %>">Request from: <%= requestId %></a></li>
                    <% }); %>
                <% } else { %>
                    <li>No pending requests.</li>
                <% } %>
            </ul>
            <h3>Sent Friend Requests</h3>
            <ul>
                <% if (user.sentRequests && user.sentRequests.length > 0) { %>
                    <% user.sentRequests.forEach(function(sentId) { %>
                        <li><a href="/users/profile/<%= sentId %>">Sent to: <%= sentId %></a></li>
                    <% }); %>
                <% } else { %>
                    <li>No sent requests.</li>
                <% } %>
            </ul>
        <% } %>
    <% } else { %>
        <p>User profile not found.</p>
        <ul>
            <li><a href="/users/sign-in">Sign In</a></li>
            <li><a href="/users/sign-up">Sign Up</a></li>
        </ul>
    <% } %>

</body>
</html>
